<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard - Gestión de Tareas Académicas</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    .user-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #0d6efd;
      color: #fff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
    }
    .bg-success-subtle { background-color: #d1fae5 !important; }

    /* Estilos para modo oscuro personalizados */
    html[data-bs-theme="dark"] {
      background-color: #121212;
      color: #e0e0e0;
    }
    html[data-bs-theme="dark"] .card, 
    html[data-bs-theme="dark"] .list-group-item {
      background-color: #1e1e1e;
      color: #e0e0e0;
      border-color: #333;
    }
    html[data-bs-theme="dark"] .form-control {
      background-color: #333;
      color: #fff;
      border-color: #555;
    }
    html[data-bs-theme="dark"] .modal-content {
      background-color: #1e1e1e;
      color: #fff;
    }
    html[data-bs-theme="dark"] .btn-close {
      filter: invert(1);
    }
    #toggleTheme {
      margin-top: 10px;
      margin-right: 30px;
      margin-bottom: 10px;
      float: right;
    }
  </style>
</head>

<body>
  <header class="bg-primary text-white p-3">
    <div class="container">
      <!-- Título y dropdown de usuario -->
      <div class="d-flex justify-content-between align-items-center">
        <h1 class="h3 mb-0">📚 Gestión de Tareas Académicas</h1>
        <div class="d-flex align-items-center">
          <button id="notifBtn" class="btn btn-light btn-sm me-3 position-relative">
            <i class="bi bi-bell"></i>
            <span id="notifBadge" class="position-absolute top-0 start-100 translate-middle badge bg-danger" style="display:none">0</span>
          </button>

          <div class="dropdown text-end">
            <a href="#" class="d-flex align-items-center text-white text-decoration-none dropdown-toggle" id="userDropdown" data-bs-toggle="dropdown">
              <div class="user-avatar me-2" id="userAvatar">U</div>
              <span id="userName">Usuario</span>
            </a>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item text-yellow" href="#" id="logoutBtn"><i class="bi bi-box-arrow-right"></i> Cerrar sesión</a></li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Botón de modo oscuro -->
      <div class="d-flex justify-content-start mt-2">
        <button id="toggleTheme" class="btn btn-light btn-sm">Modo Oscuro</button>
      </div>
    </div>
  </header>

  <main class="container my-4">
    <h2>📌 Mis Tareas</h2>
    <!-- Botón que redirige a add-task.html -->
    <a href="add-task.html" class="btn btn-success mb-3">➕ Nueva Tarea</a>

    <ul class="list-group" id="taskList">
      <li class="list-group-item text-center text-muted">Cargando tareas...</li>
    </ul>
  </main>

  <!-- Modal: Notificaciones -->
  <div class="modal fade" id="notificationsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">🔔 Notificaciones</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="notificationsList">
          <p class="text-muted">No hay notificaciones.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Elementos
      const taskList = document.getElementById('taskList');
      const notifBtn = document.getElementById('notifBtn');
      const notifBadge = document.getElementById('notifBadge');
      const notificationsList = document.getElementById('notificationsList');
      const notifModal = new bootstrap.Modal(document.getElementById('notificationsModal'));
      const logoutBtn = document.getElementById('logoutBtn');
      const toggleThemeBtn = document.getElementById('toggleTheme');

      // Estado
      let tasks = [];
      let currentUser = null;
      let notifications = [];

      // Utilidades
      function safeParse(key) {
        try {
          return JSON.parse(localStorage.getItem(key));
        } catch {
          return null;
        }
      }

      // Cargar usuario
      function loadUser() {
        const user = safeParse('currentUser');
        if (!user) {
          window.location.href = 'index.html';
          return null;
        }
        currentUser = user;
        document.getElementById('userName').textContent = user.name.split(' ')[0];
        document.getElementById('userAvatar').textContent = user.name.charAt(0).toUpperCase();
        return user;
      }

      // Clave única por usuario
      function getUserTasksKey() {
        return `tasks_${currentUser.email}`;
      }

      // Cargar tareas
      function loadTasks() {
        const key = getUserTasksKey();
        const data = safeParse(key);
        tasks = Array.isArray(data) ? data : [];
      }

      // Guardar tareas
      function saveTasks() {
        const key = getUserTasksKey();
        localStorage.setItem(key, JSON.stringify(tasks));
      }

      // Formatear fecha
      function formatDate(dateStr) {
        if (!dateStr) return '';
        return new Date(dateStr).toLocaleDateString('es-ES', {
          day: '2-digit',
          month: '2-digit',
          year: '2-digit'
        });
      }

      // Días restantes
      function daysUntil(dateStr) {
        const today = new Date();
        const due = new Date(dateStr);
        today.setHours(0, 0, 0, 0);
        due.setHours(0, 0, 0, 0);
        return Math.ceil((due - today) / (1000 * 60 * 60 * 24));
      }

      // Generar notificaciones
      function generateNotifications() {
        const notifs = [];
        tasks.forEach(t => {
          if (t.completed) return;
          const left = daysUntil(t.dueDate);
          if (left < 0) {
            notifs.push(`❌ ${t.subject}: vencida (${formatDate(t.dueDate)})`);
          } else if (left <= 10) {
            notifs.push(`⚠️ ${t.subject}: vence en ${left} día${left !== 1 ? 's' : ''}`);
          }
        });
        notifications = notifs;

        // Mostrar u ocultar badge
        notifBadge.style.display = notifs.length ? 'inline' : 'none';
        notifBadge.textContent = notifs.length;
      }

      // Renderizar tareas
      function renderTasks() {
        taskList.innerHTML = '';
        if (tasks.length === 0) {
          taskList.innerHTML = '<li class="list-group-item text-center text-muted">No tienes tareas aún.</li>';
          return;
        }

        tasks.forEach(task => {
          const li = document.createElement('li');
          li.className = `list-group-item d-flex flex-column ${task.completed ? 'bg-success-subtle' : ''}`;
          li.dataset.id = task.id;

          const left = daysUntil(task.dueDate);
          const statusClass = left < 0 ? 'text-danger fw-bold' : left <= 3 ? 'text-warning fw-bold' : 'text-muted';
          const leftText = left < 0 ? `${Math.abs(left)} día(s) vencida` : `${left} día${left !== 1 ? 's' : ''}`;

          li.innerHTML = `
            <div class="w-100">
              <div class="d-flex justify-content-between align-items-start">
                <h5 class="mb-1">${escapeHtml(task.subject)}</h5>
                <span class="badge bg-info text-dark">${formatDate(task.dueDate)}</span>
              </div>
              <p class="mb-1 text-secondary">${escapeHtml(task.description || 'Sin descripción')}</p>
              <div class="d-flex justify-content-between align-items-center mt-2">
                <small class="text-muted">Quedan: <span class="${statusClass}">${leftText}</span></small>
                <div>
                  <button class="btn btn-sm btn-success complete-btn" title="Completar/Reactivar">${task.completed ? '🔄' : '✔️'}</button>
                  <button class="btn btn-sm btn-warning edit-btn" title="Editar">✏️</button>
                  <button class="btn btn-sm btn-danger delete-btn" title="Eliminar">🗑️</button>
                </div>
              </div>
            </div>
          `;
          taskList.appendChild(li);
        });
      }

      // Protección XSS
      function escapeHtml(str = '') {
        return String(str)
          .replace(/&/g, '&amp;')
          .replace(/</g, '<')
          .replace(/>/g, '>')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }

      // Eventos en la lista de tareas
      taskList.addEventListener('click', (e) => {
        const li = e.target.closest('li');
        if (!li) return;
        const id = Number(li.dataset.id);
        const idx = tasks.findIndex(t => t.id === id);
        if (idx === -1) return;

        if (e.target.closest('.complete-btn')) {
          tasks[idx].completed = !tasks[idx].completed;
          saveTasks(); renderTasks(); generateNotifications();
        } else if (e.target.closest('.delete-btn')) {
          if (confirm(`¿Eliminar tarea "${tasks[idx].subject}"?`)) {
            tasks.splice(idx, 1);
            saveTasks(); renderTasks(); generateNotifications();
          }
        } else if (e.target.closest('.edit-btn')) {
          const newSubject = prompt('Materia:', tasks[idx].subject);
          if (!newSubject) return;
          const newDesc = prompt('Descripción:', tasks[idx].description || '');
          const newDue = prompt('Fecha (YYYY-MM-DD):', tasks[idx].dueDate);
          if (!newDue || !/^\d{4}-\d{2}-\d{2}$/.test(newDue)) {
            alert('Fecha inválida');
            return;
          }
          tasks[idx].subject = newSubject.trim();
          tasks[idx].description = newDesc.trim();
          tasks[idx].dueDate = newDue;
          saveTasks(); renderTasks(); generateNotifications();
        }
      });

      // Notificaciones: ocultar badge al verlas
      notifBtn.addEventListener('click', () => {
        notificationsList.innerHTML = notifications.length
          ? notifications.map(n => `<p class="mb-1">${escapeHtml(n)}</p>`).join('')
          : '<p class="text-muted">No hay notificaciones.</p>';

        // ✅ Ocultar el badge al abrir
        notifBadge.style.display = 'none';

        notifModal.show();
      });

      // Modo oscuro
      function applyTheme(theme) {
        document.documentElement.setAttribute('data-bs-theme', theme);
        toggleThemeBtn.textContent = theme === 'dark' ? 'Modo Claro' : 'Modo Oscuro';
      }

      toggleThemeBtn.addEventListener('click', () => {
        const current = localStorage.getItem('theme') || 'light';
        const next = current === 'dark' ? 'light' : 'dark';
        localStorage.setItem('theme', next);
        applyTheme(next);
      });

      // Cerrar sesión
      logoutBtn.addEventListener('click', (e) => {
        e.preventDefault();
        localStorage.removeItem('currentUser');
        window.location.href = 'index.html';
      });

      // Inicialización
      function init() {
        currentUser = loadUser();
        if (!currentUser) return;

        // Aplicar tema
        const savedTheme = localStorage.getItem('theme') || 'light';
        applyTheme(savedTheme);

        // Cargar tareas
        loadTasks();
        renderTasks();
        generateNotifications();

        // Mostrar notificaciones al inicio si hay
        if (notifications.length > 0) {
          setTimeout(() => notifModal.show(), 500);
        }
      }

      // Ejecutar
      init();
    });
  </script>
</body>
</html>

